<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHAT //</title>
    <link rel="icon" type="image/png" href="https://em-content.zobj.net/source/apple/114/speech-balloon_1f4ac.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://www.lucaspanzera.com/style.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'cyber-bg': 'var(--bg-color)',
                        'cyber-card': 'var(--card-bg)',
                        'cyber-text': 'var(--text-primary)',
                        'cyber-dim': 'var(--text-secondary)',
                        'cyber-border': 'var(--border-color)',
                    },
                    screens: {
                        'xs': '480px',
                    }
                }
            }
        }
    </script>
</head>

<body class="min-h-screen dither-bg dither-overlay selection:bg-white selection:text-black font-mono overflow-hidden">

    <div class="scanlines"></div>

    <main class="min-h-screen flex items-center justify-center p-4">

        <!-- Chat Section -->
        <div id="chat" class="bento-card w-full max-w-6xl h-[80vh] flex-row relative hidden">
            <!-- Sidebar -->
            <div class="w-64 border-r border-cyber-border flex flex-col overflow-y-auto">
                <div class="p-4 border-b border-cyber-border">
                    <h3 class="text-xs font-bold tracking-wider mb-2">CHANNELS</h3>
                    <button onclick="switchToGeneral()" id="generalBtn" 
                            class="w-full text-left text-xs p-2 hover:bg-cyber-card transition-colors border border-cyber-border mb-2 relative flex items-center justify-between">
                        <span># GENERAL</span>
                        <span id="generalBadge" class="hidden bg-red-500 text-white text-[10px] px-1.5 py-0.5 rounded-full animate-pulse">0</span>
                    </button>
                </div>
                
                <div class="p-4 border-b border-cyber-border">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-xs font-bold tracking-wider">GROUPS</h3>
                        <button onclick="showCreateGroup()" class="text-xs hover:text-green-500 transition-colors">[ + ]</button>
                    </div>
                    <div id="groupsList" class="space-y-1"></div>
                </div>

                <div class="p-4 border-b border-cyber-border">
                    <h3 class="text-xs font-bold tracking-wider mb-2">DIRECT MESSAGES</h3>
                    <div id="usersList" class="space-y-1"></div>
                </div>
            </div>

            <!-- Main Chat -->
            <div class="flex-1 flex flex-col">
                <div class="flex justify-between items-center border-b border-cyber-border pb-4 mb-4">
                    <div class="flex items-center gap-3">
                        <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                        <div>
                            <h2 class="text-sm font-bold tracking-wider">SECURE CHANNEL</h2>
                            <p class="text-[10px] text-cyber-dim font-mono">ENCRYPTED // <span id="current-user"
                                    class="text-cyber-text">GUEST</span></p>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <span class="text-xs-custom hidden sm:inline">
                            <span id="online-count" class="text-green-500">0</span> ONLINE
                        </span>
                        <span class="text-xs-custom hidden sm:inline">STATUS: CONNECTED</span>
                        <button onclick="disconnect()"
                            class="text-xs-custom hover:text-red-500 transition-colors">[
                            DISCONNECT ]</button>
                    </div>
                </div>

                <div id="messages" class="flex-1 overflow-y-auto space-y-4 pr-2 mb-4 font-mono text-sm scrollbar-thin">
                    <div class="text-center py-4">
                        <span class="text-xs text-cyber-dim border border-cyber-border px-2 py-1 bg-cyber-bg/50">SYSTEM
                            INITIALIZED</span>
                    </div>
                </div>

                <div class="mt-auto pt-4 border-t border-cyber-border">
                    <div class="flex gap-2">
                        <span class="py-3 text-cyber-dim select-none">></span>
                        <input type="text" id="message" placeholder="ENTER MESSAGE..."
                            class="flex-1 bg-transparent border-none text-cyber-text focus:outline-none placeholder-cyber-dim/50"
                            onkeypress="if(event.key==='Enter')sendMessage()">
                        <button onclick="sendMessage()"
                            class="text-xs border border-cyber-border px-4 hover:bg-white hover:text-black transition-colors tracking-widest">
                            SEND
                        </button>
                    </div>
                </div>
                <div
                    class="mt-4 bento-card col-span-2 md:col-span-4 md:row-span-1 flex flex-col md:flex-row items-center justify-between py-4 gap-4 text-center md:text-left">
                    <div
                        class="flex flex-wrap justify-center md:justify-start gap-3 sm:gap-4 text-xs-custom text-cyber-dim font-mono">
                        <span>STATUS: <span class="text-green-500">OK</span></span>
                        <span class="hidden sm:inline text-cyber-border">|</span>
                        <span>TIME: <span id="uptime" class="text-cyber-text">00:00:00</span></span>
                        <span class="hidden sm:inline text-cyber-border">|</span>
                        <span>KERNEL: <span class="text-cyber-text">6.8.0-LTS</span></span>
                        <span class="hidden sm:inline text-cyber-border">|</span>
                        <span>SHELL: <span class="text-cyber-text">ZSH</span></span>
                    </div>
                    <div class="text-xs-custom text-cyber-dim whitespace-nowrap">
                        POWERED BY <a href="https://www.stelestial.app" target="_blank"
                            class="hover:text-white underline decoration-dotted">STELESTIAL</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Create Group -->
        <div id="createGroupModal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50">
            <div class="bento-card w-full max-w-md p-6 flex flex-col gap-4">
                <div class="flex justify-between items-center">
                    <h2 class="text-xl font-bold">CRIAR GRUPO</h2>
                    <button onclick="hideCreateGroup()" class="text-xs hover:text-red-500">[ X ]</button>
                </div>

                <input type="text" id="groupName" placeholder="NOME DO GRUPO..."
                    class="w-full bg-cyber-bg border border-cyber-border p-3 text-cyber-text focus:outline-none uppercase">

                <div class="max-h-60 overflow-y-auto border border-cyber-border p-2">
                    <p class="text-xs text-cyber-dim mb-2">Selecione os membros (mínimo 2):</p>
                    <div id="groupMembersList" class="space-y-2"></div>
                </div>

                <div id="createGroupError" class="text-red-500 text-xs hidden"></div>

                <button onclick="createGroup()" id="createGroupBtn"
                    class="w-full text-center text-xs border border-cyber-border px-4 py-3 hover:bg-white hover:text-black transition-colors tracking-[0.2em] font-bold">
                    [ CRIAR ]
                </button>
            </div>
        </div>
    </main>

    <script>
        // Verificar autenticação
        const token = localStorage.getItem('token');
        const user = JSON.parse(localStorage.getItem('user') || '{}');

        if (!token || !user.username) {
            window.location.href = '/auth.html';
        }

        let ws;
        let currentUser = user.username;

        document.getElementById('current-user').innerText = currentUser.toUpperCase();
        document.getElementById('chat').classList.remove('hidden');
        document.getElementById('chat').classList.add('flex');

        let currentRoomID = '00000000-0000-0000-0000-000000000001';
        let currentRoomUser = null;
        let unreadMessages = {}; // { roomID: count }
        let allRooms = {}; // { roomID: { username, element } }

        // Conectar com token
        function connectWebSocket() {
            ws = new WebSocket(`ws://localhost:8080/ws?token=${encodeURIComponent(token)}&roomId=${currentRoomID}`);

            ws.onopen = () => {
                console.log('WebSocket conectado');
                loadHistory();
                // Resetar badge da sala atual
                updateBadge(currentRoomID, 0);
            };

            ws.onmessage = (event) => {
                const msg = JSON.parse(event.data);
                
                // Se a mensagem é de outra sala e não é do tipo count
                if (msg.roomId && msg.roomId !== currentRoomID && msg.type !== 'count') {
                    incrementUnread(msg.roomId);
                }
                
                addMessage(msg);
            };

            ws.onclose = () => {
                console.log('WebSocket desconectado');
            };

            ws.onerror = (err) => {
                console.error('WebSocket error:', err);
                alert('Erro de conexão. Verifique sua autenticação.');
                logout();
            };
        }

        function disconnect() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.close();
            }
            logout();
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = '/auth.html';
        }

        function incrementUnread(roomID) {
            if (!unreadMessages[roomID]) {
                unreadMessages[roomID] = 0;
            }
            unreadMessages[roomID]++;
            updateBadge(roomID, unreadMessages[roomID]);
            
            // Atualizar título da página
            updatePageTitle();
        }

        function updateBadge(roomID, count) {
            // Atualizar badge do General
            if (roomID === '00000000-0000-0000-0000-000000000001') {
                const badge = document.getElementById('generalBadge');
                if (count > 0) {
                    badge.textContent = count > 99 ? '99+' : count;
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
            } else {
                // Atualizar badge de DM
                const badge = document.getElementById(`badge-${roomID}`);
                if (badge) {
                    if (count > 0) {
                        badge.textContent = count > 99 ? '99+' : count;
                        badge.classList.remove('hidden');
                    } else {
                        badge.classList.add('hidden');
                    }
                }
            }
        }

        function updatePageTitle() {
            const totalUnread = Object.values(unreadMessages).reduce((sum, count) => sum + count, 0);
            if (totalUnread > 0) {
                document.title = `(${totalUnread}) CHAT //`;
            } else {
                document.title = 'CHAT //';
            }
        }

        async function loadUsers() {
            try {
                const response = await fetch('/api/users', {
                    headers: { 'Authorization': token }
                });
                const users = await response.json();
                
                const usersList = document.getElementById('usersList');
                usersList.innerHTML = users.map(u => {
                    const statusColor = u.isOnline ? 'bg-green-500' : 'bg-gray-500';
                    const statusTitle = u.isOnline ? 'Online' : formatLastSeen(u.lastSeen);
                    return `
                        <button onclick="startPrivateChat('${u.id}', '${u.username}')" 
                                id="user-${u.id}"
                                class="w-full text-left text-xs p-2 hover:bg-cyber-card transition-colors relative flex items-center justify-between"
                                title="${statusTitle}">
                            <div class="flex items-center gap-2">
                                <span class="w-2 h-2 ${statusColor} rounded-full ${u.isOnline ? 'animate-pulse' : ''}"></span>
                                <span>@ ${u.username}</span>
                            </div>
                            <span id="badge-temp-${u.id}" class="hidden bg-red-500 text-white text-[10px] px-1.5 py-0.5 rounded-full animate-pulse">0</span>
                        </button>
                    `;
                }).join('');
            } catch (err) {
                console.error('Erro ao carregar usuários:', err);
            }
        }

        function formatLastSeen(lastSeen) {
            if (!lastSeen) return 'Nunca visto';
            
            const date = new Date(lastSeen);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'Visto agora';
            if (diffMins < 60) return `Visto há ${diffMins} min`;
            if (diffHours < 24) return `Visto há ${diffHours}h`;
            if (diffDays < 7) return `Visto há ${diffDays} dias`;
            
            return `Visto em ${date.toLocaleDateString('pt-BR')}`;
        }

        // Atualizar lista de usuários a cada 30 segundos
        setInterval(loadUsers, 30000);

        async function startPrivateChat(otherUserID, username) {
            try {
                console.log('Iniciando chat privado com:', username, otherUserID);
                
                const response = await fetch('/api/room/private', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': token 
                    },
                    body: JSON.stringify({ otherUserId: otherUserID })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Erro ${response.status}: ${errorText}`);
                }
                
                const room = await response.json();
                console.log('Sala criada:', room);
                
                // Atualizar o badge com o ID real da sala
                const tempBadge = document.getElementById(`badge-temp-${otherUserID}`);
                if (tempBadge) {
                    tempBadge.id = `badge-${room.id}`;
                }
                
                currentRoomID = room.id;
                currentRoomUser = username;
                
                // Resetar contador de não lidas desta sala
                unreadMessages[room.id] = 0;
                updateBadge(room.id, 0);
                updatePageTitle();
                
                document.querySelector('h2').textContent = `DM: ${username}`;
                
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.close();
                }
                
                connectWebSocket();
            } catch (err) {
                console.error('Erro ao criar sala privada:', err);
                alert('Erro ao criar sala privada: ' + err.message);
            }
        }

        function switchToGeneral() {
            currentRoomID = '00000000-0000-0000-0000-000000000001';
            currentRoomUser = null;
            
            // Resetar contador de não lidas do General
            unreadMessages[currentRoomID] = 0;
            updateBadge(currentRoomID, 0);
            updatePageTitle();
            
            document.querySelector('h2').textContent = 'SECURE CHANNEL';
            
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.close();
            }
            
            connectWebSocket();
        }

        function loadHistory() {
            fetch(`/api/room/messages?roomId=${currentRoomID}&limit=50`)
                .then(response => response.json())
                .then(messages => {
                    if (messages && messages.length > 0) {
                        const messagesDiv = document.getElementById('messages');
                        messagesDiv.innerHTML = '';
                        
                        messages.forEach(msg => {
                            addMessage(msg, true);
                        });
                        
                        messagesDiv.scrollTop = messagesDiv.scrollHeight;
                    }
                })
                .catch(err => {
                    console.error('Erro ao carregar histórico:', err);
                });
        }

        function sendMessage() {
            const input = document.getElementById('message');
            const content = input.value.trim();
            if (!content) return;

            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ content }));
            } else {
                alert('Conexão perdida. Reconectando...');
                connectWebSocket();
            }

            input.value = '';
            input.focus();
        }

        function addMessage(msg, skipScroll = false) {
            // Atualizar contagem se presente
            if (msg.onlineCount !== undefined) {
                document.getElementById('online-count').innerText = msg.onlineCount;
            }

            // Se for apenas mensagem de contagem, não adicionar ao chat
            if (msg.type === 'count') {
                return;
            }

            const messagesDiv = document.getElementById('messages');
            const div = document.createElement('div');
            const isMe = msg.username === currentUser;
            
            // Converter timestamp para horário de Brasília
            let time = '';
            try {
                let date;
                if (msg.timestamp) {
                    // Tentar parse direto
                    date = new Date(msg.timestamp);
                    
                    // Se for inválido, tentar adicionar Z
                    if (isNaN(date.getTime())) {
                        date = new Date(msg.timestamp + 'Z');
                    }
                    
                    // Se ainda for inválido, usar hora atual
                    if (isNaN(date.getTime())) {
                        date = new Date();
                    }
                } else {
                    date = new Date();
                }
                
                time = date.toLocaleTimeString('pt-BR', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    timeZone: 'America/Sao_Paulo'
                });
            } catch (e) {
                console.error('Erro ao parsear timestamp:', e);
                time = new Date().toLocaleTimeString('pt-BR', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    timeZone: 'America/Sao_Paulo'
                });
            }

            if (msg.type === 'system' || msg.type === 'join' || msg.type === 'leave') {
                div.className = 'flex justify-center my-2 px-4';
                div.innerHTML = `<span class="text-xs text-cyber-dim border border-cyber-border px-2 py-1 bg-cyber-bg/50">${msg.content}</span>`;
            } else {
                div.className = `flex flex-col ${isMe ? 'items-end pr-4' : 'items-start pl-4'} animate-fade-in`;
                div.innerHTML = `
                    <div class="flex items-baseline gap-2 mb-1">
                        <span class="text-xs font-bold ${isMe ? 'text-green-500' : 'text-blue-400'}">${msg.username}</span>
                        <span class="text-[10px] text-cyber-dim">${time}</span>
                    </div>
                    <div class="max-w-[80%] p-3 rounded-sm border ${isMe ? 'border-green-500/30 bg-green-500/5' : 'border-cyber-border bg-cyber-card'}">
                        <p class="leading-relaxed break-words">${msg.content}</p>
                    </div>
                `;
            }

            messagesDiv.appendChild(div);
            
            if (!skipScroll) {
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }
        }
        function updateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('pt-BR', { timeZone: 'America/Sao_Paulo' });
            const uptimeElement = document.getElementById('uptime');
            if (uptimeElement) {
                uptimeElement.innerText = timeString;
            }
        }
        setInterval(updateTime, 1000);
        updateTime();

        let selectedMembers = new Set();

        async function loadGroups() {
            try {
                const response = await fetch('/api/groups', {
                    headers: { 'Authorization': token }
                });
                const groups = await response.json();
                
                const groupsList = document.getElementById('groupsList');
                if (groups && groups.length > 0) {
                    groupsList.innerHTML = groups.map(g => `
                        <button onclick="switchToGroup('${g.id}', '${g.name}')" 
                                id="group-${g.id}"
                                class="w-full text-left text-xs p-2 hover:bg-cyber-card transition-colors relative flex items-center justify-between">
                            <span># ${g.name}</span>
                            <span id="badge-${g.id}" class="hidden bg-red-500 text-white text-[10px] px-1.5 py-0.5 rounded-full animate-pulse">0</span>
                        </button>
                    `).join('');
                } else {
                    groupsList.innerHTML = '<p class="text-xs text-cyber-dim italic">Nenhum grupo ainda</p>';
                }
            } catch (err) {
                console.error('Erro ao carregar grupos:', err);
            }
        }

        function showCreateGroup() {
            document.getElementById('createGroupModal').classList.remove('hidden');
            loadUsersForGroup();
        }

        function hideCreateGroup() {
            document.getElementById('createGroupModal').classList.add('hidden');
            selectedMembers.clear();
            document.getElementById('groupName').value = '';
        }

        async function loadUsersForGroup() {
            try {
                const response = await fetch('/api/users', {
                    headers: { 'Authorization': token }
                });
                const users = await response.json();
                
                const membersList = document.getElementById('groupMembersList');
                membersList.innerHTML = users.map(u => `
                    <label class="flex items-center gap-2 cursor-pointer hover:bg-cyber-card p-2">
                        <input type="checkbox" value="${u.id}" onchange="toggleMember('${u.id}')"
                               class="w-4 h-4">
                        <span class="text-xs">@ ${u.username}</span>
                    </label>
                `).join('');
            } catch (err) {
                console.error('Erro ao carregar usuários:', err);
            }
        }

        function toggleMember(userID) {
            if (selectedMembers.has(userID)) {
                selectedMembers.delete(userID);
            } else {
                selectedMembers.add(userID);
            }
        }

        async function createGroup() {
            const name = document.getElementById('groupName').value.trim();
            const errorDiv = document.getElementById('createGroupError');
            const btn = document.getElementById('createGroupBtn');

            errorDiv.classList.add('hidden');

            if (!name) {
                errorDiv.textContent = '⚠ Nome do grupo é obrigatório';
                errorDiv.classList.remove('hidden');
                return;
            }

            if (selectedMembers.size < 2) {
                errorDiv.textContent = '⚠ Selecione no mínimo 2 membros';
                errorDiv.classList.remove('hidden');
                return;
            }

            btn.disabled = true;
            btn.textContent = '[ CRIANDO... ]';

            try {
                const response = await fetch('/api/group/create', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': token 
                    },
                    body: JSON.stringify({ 
                        name: name,
                        userIds: Array.from(selectedMembers)
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText);
                }

                const group = await response.json();
                console.log('Grupo criado:', group);

                hideCreateGroup();
                await loadGroups();
                
                // Entrar no grupo criado
                switchToGroup(group.id, group.name);
            } catch (err) {
                console.error('Erro ao criar grupo:', err);
                errorDiv.textContent = '⚠ ' + err.message;
                errorDiv.classList.remove('hidden');
            } finally {
                btn.disabled = false;
                btn.textContent = '[ CRIAR ]';
            }
        }

        function switchToGroup(groupId, groupName) {
            currentRoomID = groupId;
            currentRoomUser = null;
            
            unreadMessages[groupId] = 0;
            updateBadge(groupId, 0);
            updatePageTitle();
            
            document.querySelector('h2').textContent = `GROUP: ${groupName}`;
            
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.close();
            }
            
            connectWebSocket();
        }

        // Carregar grupos e usuários ao conectar
        loadGroups();
        loadUsers();
        connectWebSocket();

        // Detectar quando a aba fica visível novamente
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden && currentRoomID) {
                // Resetar contador da sala atual quando voltar
                unreadMessages[currentRoomID] = 0;
                updateBadge(currentRoomID, 0);
                updatePageTitle();
            }
        });
    </script>
</body>

</html>